name: Validate PR

on:
  pull_request:
    branches: [main]

jobs:
  validate-clubs:
    name: Validate club data
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"

      - name: Validate club frontmatter
        run: ruby scripts/validate_clubs.rb

  build:
    name: Jekyll build & JSON check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: ruby/setup-ruby@v1
        with:
          ruby-version: "3.3"
          bundler-cache: true

      - name: Build site
        run: bundle exec jekyll build

      - name: Validate clubs.json
        run: |
          ruby -e '
            require "json"

            path = "_site/api/clubs.json"
            unless File.exist?(path)
              puts "ERROR: #{path} not found"
              exit 1
            end

            begin
              clubs = JSON.parse(File.read(path))
            rescue JSON::ParserError => e
              puts "ERROR: Invalid JSON in #{path}: #{e.message}"
              exit 1
            end

            unless clubs.is_a?(Array)
              puts "ERROR: Expected an array, got #{clubs.class}"
              exit 1
            end

            required_keys = %w[name slug url day frequency location description]
            errors = []

            clubs.each_with_index do |club, i|
              required_keys.each do |key|
                if club[key].nil?
                  errors << "Club ##{i} (#{club["name"] || "unknown"}): missing \"#{key}\""
                end
              end

              loc = club["location"]
              if loc.is_a?(Hash)
                %w[name address lat lng].each do |key|
                  if loc[key].nil?
                    errors << "Club ##{i} (#{club["name"] || "unknown"}): missing \"location.#{key}\""
                  end
                end
              end
            end

            if errors.any?
              puts "clubs.json validation failed!\n\n"
              errors.each { |e| puts "  - #{e}" }
              exit 1
            end

            puts "clubs.json is valid: #{clubs.length} clubs with all required fields."
          '
